{% extends "base.html" %}

{% block content %}
<div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-sm border-r border-gray-200 min-h-screen">
        <!-- Navegación -->
        <nav class="p-4 space-y-2">
            <!-- Visualizar Datos -->
            <a href="{{ url_for('main.visualizar_datos') }}" class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-14 h-14 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M0 13h16v2h-16zM2 9h2v3h-2zM5 5h2v7h-2zM8 8h2v4h-2zM11 2h2v10h-2z"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-900">Visualizar Datos de Entrenamiento</div>
                        <div class="text-sm text-gray-500">Gráficos y análisis de datos</div>
                    </div>
                </div>
            </a>

            <!-- Predicción Individual -->
            <a href="{{ url_for('main.prediccion_individual') }}" class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-900">Predicción Individual</div>
                        <div class="text-sm text-gray-500">Predecir deserción de un cliente</div>
                    </div>
                </div>
            </a>

            <!-- Predicción Masiva -->
            <a href="{{ url_for('main.analisis_masivo') }}" class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-900">Predicción Masiva</div>
                        <div class="text-sm text-gray-500">Procesar múltiples clientes</div>
                    </div>
                </div>
            </a>
        </nav>
    </div>

    <!-- Contenido Principal -->
    <div class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Breadcrumb -->
            <div class="mb-8">
                <nav class="flex items-center space-x-2 text-sm text-gray-500">
                    <a href="{{ url_for('main.index') }}" class="hover:text-gray-700">Inicio</a>
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <a href="{{ url_for('main.analisis_masivo') }}" class="hover:text-gray-700">Análisis Masivo</a>
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-gray-900">Resultados</span>
                </nav>
            </div>

            <!-- Título de la Sección -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Resultados del Análisis Masivo</h1>
                <p class="text-gray-600">Predicciones y análisis detallado de {{ resultados.estadisticas.total_clientes }} clientes</p>
            </div>

            <!-- Estadísticas Principales -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-gray-900">{{ resultados.estadisticas.total_clientes }}</div>
                    <div class="text-sm text-gray-600">Total Clientes</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-green-600">{{ resultados.estadisticas.clientes_fieles }}</div>
                    <div class="text-sm text-gray-600">Clientes Fieles</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-red-600">{{ resultados.estadisticas.posibles_desertores }}</div>
                    <div class="text-sm text-gray-600">Posibles Desertores</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-orange-600">{{ resultados.estadisticas.riesgo_alto }}</div>
                    <div class="text-sm text-gray-600">Riesgo Alto</div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Gráfico de Torta -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Distribución por Riesgo</h2>
                    <canvas id="pieChart" width="400" height="400"></canvas>
                </div>

                <!-- Gráfico Sigmoide -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Relación entre Z-Score vs Probabilidad de Deserción</h2>
                    <canvas id="sigmoidChart" width="400" height="400"></canvas>
                </div>
            </div>

            <!-- Tabla de Resultados Detallados -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Resultados Detallados</h2>
                        <p class="text-gray-600">Tabla interactiva con todas las predicciones</p>
                    </div>
                    <div class="flex space-x-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Buscar por ID" 
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    
                    <!-- Botón Personalizar Reporte -->
                    <button id="personalizarBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                        </svg>
                        <span>Personalizar Reporte</span>
                    </button>
                    
                    <!-- Botón Exportar PDF -->
                    <button id="exportPdfBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <span>Exportar PDF</span>
                    </button>
                </div>
                </div>

                <div class="overflow-x-auto">
                    <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                    ID <span class="ml-1">⇅</span>
                                </th>
                               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                    Calidad Servicio <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                    Tasa Interés <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                    Estado Ahorro <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(4)">
                                    Productos Vigentes <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(5)">
                                    Edad <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(6)">
                                Probabilidad <span class="ml-1">⇅</span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(7)">
                                Riesgo <span class="ml-1">⇅</span>
                            </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            {% for cliente in resultados.datos_detallados %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ cliente.id }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ cliente.calidad_servicio }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ cliente.tasa_interes }}%</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {% if cliente.estado_ahorro_activo == 1 %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Activo
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            Inactivo
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ cliente.n_productos_vigentes }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ cliente.edad }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div class="flex items-center">
                                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-3">
                                            <div class="bg-blue-600 h-2 rounded-full" 
                                                style="width: {{ (cliente.probabilidad * 100) | round(1) }}%"></div>
                                        </div>
                                        <span>{{ (cliente.probabilidad * 100)|round(1) }}%</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if cliente.riesgo == 'ALTO' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            ALTO
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            BAJO
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
  {% if cliente.riesgo == 'ALTO' %}
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-red-100 text-red-800 font-medium">
      <!-- Icono de alerta -->
      <svg class="w-4 h-4 mr-1 text-red-600" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l6.518 11.58c.75 1.333-.214 2.951-1.742 2.951H3.48c-1.528 0-2.492-1.618-1.742-2.95l6.518-11.58zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-4a1 1 0 00-.993.883L9 10v2a1 1 0 001.993.117L11 12v-2a1 1 0 00-1-1z"
              clip-rule="evenodd" />
      </svg>
      
    </span>
  {% else %}
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-green-100 text-green-800 font-medium">
      <!-- Icono de check -->
      <svg class="w-4 h-4 mr-1 text-green-600" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414L8.414 15 5.293 11.879a1 1 0 00-1.414 1.415l4 4a1 1 0 001.414 0l9-9a1 1 0 00-1.414-1.415l-8.293 8.292-3.586-3.585a1 1 0 011.414-1.415L8.414 13l8.293-8.293a1 1 0 011.414 0z"
              clip-rule="evenodd" />
      </svg>
      
    </span>
  {% endif %}
</td>

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación info -->
                <div class="mt-4 text-sm text-gray-500">
                    Mostrando <span id="showingInfo">{{ resultados.datos_detallados|length }}</span> de {{ resultados.estadisticas.total_clientes }} resultados
                </div>
            </div>

            <!-- Botón para nuevo análisis -->
            <div class="mt-8 text-center">
                <a href="{{ url_for('main.analisis_masivo') }}" class="bg-gray-900 text-white px-8 py-3 rounded-lg hover:bg-gray-800 transition-colors inline-flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>Realizar Nuevo Análisis</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Datos desde el servidor
const datosResultados = JSON.parse('{{ resultados | tojson | safe }}');

// Gráfico de Torta
const pieCtx = document.getElementById('pieChart').getContext('2d');
const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: ['Clientes Fieles', 'Posibles Desertores'],
        datasets: [{
            data: [
                datosResultados.datos_torta.fieles.cantidad,
                datosResultados.datos_torta.desertores.cantidad
            ],
            backgroundColor: ['#10B981', '#EF4444'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const percentage = datosResultados.datos_torta[context.label.toLowerCase().replace(' ', '_').replace('posibles_', '')].porcentaje;
                        return context.label + ': ' + context.parsed + ' (' + percentage.toFixed(1) + '%)';
                    }
                }
            }
        }
    }
});

// Gráfico Sigmoide
const sigmoidCtx = document.getElementById('sigmoidChart').getContext('2d');
const sigmoidChart = new Chart(sigmoidCtx, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Predicciones',
            data: datosResultados.datos_sigmoide.map(item => ({
                x: item.z_score,
                y: item.sigmoide
            })),
            backgroundColor: datosResultados.datos_sigmoide.map(item => 
                item.prediccion === 1 ? '#EF4444' : '#10B981'
            ),
            borderColor: datosResultados.datos_sigmoide.map(item => 
                item.prediccion === 1 ? '#DC2626' : '#059669'
            ),
            borderWidth: 1,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Z-Score'
                },
                grid: {
                    display: true,
                    color: '#E5E7EB'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Probabilidad (Sigmoide)'
                },
                min: 0,
                max: 1,
                grid: {
                    display: true,
                    color: '#E5E7EB'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const prediccion = datosResultados.datos_sigmoide[context.dataIndex].prediccion;
                        const estado = prediccion === 1 ? 'Desertor' : 'Fiel';
                        return `Z-Score: ${context.parsed.x.toFixed(3)}, Probabilidad: ${(context.parsed.y * 100).toFixed(1)}%, Estado: ${estado}`;
                    }
                }
            }
        }
    }
});

// Funcionalidad de búsqueda en tabla
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tbody = document.getElementById('tableBody');
    const rows = tbody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const id = row.cells[0].textContent.toLowerCase();
        const calidadServicio = row.cells[1].textContent.toLowerCase();

        if (id.includes(searchTerm) ) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Actualizar contador de resultados
    document.getElementById('showingInfo').textContent = visibleCount;
});

// Funcionalidad de ordenamiento de tabla
let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.getElementById('resultsTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determinar dirección de ordenamiento
    if (!sortDirection[columnIndex]) {
        sortDirection[columnIndex] = 'asc';
    } else {
        sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
    }
    
    // Ordenar filas
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Convertir a número si es posible
        // Convertir a número si es posible
            if (columnIndex === 0 || columnIndex === 1 || columnIndex === 4 || columnIndex === 5) { // ID, Calidad Servicio, Estado Ahorro, Productos Vigentes, Edad
                aValue = parseInt(aValue);
                bValue = parseInt(bValue);
            } else if (columnIndex === 2) { // Tasa Interés
                aValue = parseFloat(aValue.replace('%', ''));
                bValue = parseFloat(bValue.replace('%', ''));
            } else if (columnIndex === 6) { // Probabilidad
                aValue = parseFloat(aValue.replace('%', ''));
                bValue = parseFloat(bValue.replace('%', ''));
            }
        
        if (sortDirection[columnIndex] === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Reordenar filas en el DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar indicadores visuales de ordenamiento
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const span = headers[i].querySelector('span');
        if (span) {
            if (i === columnIndex) {
                span.textContent = sortDirection[columnIndex] === 'asc' ? '↑' : '↓';
            } else {
                span.textContent = '⇅';
            }
        }
    }
}


// Inicialización adicional cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar que los datos estén disponibles
    if (!datosResultados) {
        console.error('No se encontraron datos de resultados');
        return;
    }
    
    // Mostrar información en consola para debug
    console.log('Total de clientes procesados:', datosResultados.estadisticas.total_clientes);
    console.log('Clientes fieles:', datosResultados.estadisticas.clientes_fieles);
    console.log('Posibles desertores:', datosResultados.estadisticas.posibles_desertores);
    
    // Actualizar contador inicial
    const totalVisible = document.querySelectorAll('#tableBody tr').length;
    document.getElementById('showingInfo').textContent = totalVisible;
});

// Funcionalidad de exportar PDF con SweetAlert2
document.getElementById('exportPdfBtn').addEventListener('click', function() {
    // Mostrar loading
    Swal.fire({
        title: 'Generando PDF...',
        html: 'Por favor espere mientras se genera el reporte completo',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Crear enlace temporal para descargar
    const link = document.createElement('a');
    link.href = "{{ url_for('main.exportar_pdf') }}";
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Simular click y limpiar
    link.click();
    document.body.removeChild(link);
    
    // Cerrar loading después de un momento y mostrar mensaje de éxito
    setTimeout(() => {
        Swal.fire({
            icon: 'success',
            title: '¡PDF Generado!',
            text: 'El reporte se ha descargado exitosamente',
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#10B981'
        });
    }, 2000);
    
    // Manejar errores (en caso de que la descarga falle)
    setTimeout(() => {
        // Verificar si el PDF se descargó (esto es una aproximación)
        const downloads = navigator.userAgent.toLowerCase().indexOf('chrome') > -1 ? 
                         'chrome://downloads/' : 'about:downloads';
        
        // Solo mostrar error si hay indicios de fallo
        link.onerror = function() {
            Swal.fire({
                icon: 'error',
                title: 'Error al generar PDF',
                text: 'Hubo un problema al generar el reporte. Por favor, intente nuevamente.',
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#EF4444'
            });
        };
    }, 5000);
});
// Variables globales para el modal
let clientesSeleccionados = [];
let todosLosClientes = [];

// Inicializar modal personalizar
document.addEventListener('DOMContentLoaded', function() {
    // Cargar todos los clientes desde los datos del servidor
    todosLosClientes = datosResultados.datos_detallados || [];
    
    // Event listeners para el modal
    document.getElementById('personalizarBtn').addEventListener('click', abrirModalPersonalizar);
    document.getElementById('closePersonalizarModal').addEventListener('click', cerrarModalPersonalizar);
    document.getElementById('cancelPersonalizar').addEventListener('click', cerrarModalPersonalizar);
    
    // Event listeners para filtros y selección
    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
    document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAll);
    document.getElementById('filterRiesgo').addEventListener('change', aplicarFiltros);
    document.getElementById('filterSearch').addEventListener('input', aplicarFiltros);
    
    // Event listener para procesar lote
    document.getElementById('procesarLoteBtn').addEventListener('click', procesarLoteSeleccionado);
});

function abrirModalPersonalizar() {
    document.getElementById('personalizarModal').classList.remove('hidden');
    cargarDatosEnModal();
}

function cerrarModalPersonalizar() {
    document.getElementById('personalizarModal').classList.add('hidden');
    limpiarSeleccion();
}

function cargarDatosEnModal() {
    const tbody = document.getElementById('personalizarTableBody');
    tbody.innerHTML = '';
    
    todosLosClientes.forEach((cliente, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 cursor-pointer'; // AÑADIR cursor-pointer
        row.dataset.clienteIndex = index;
        
        row.innerHTML = `
            <td class="px-3 py-4 whitespace-nowrap">
                <input type="checkbox" class="cliente-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                       data-cliente-id="${cliente.id}" data-index="${index}">
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cliente.id}</td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${cliente.calidad_servicio}</td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.tasa_interes}%</td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                ${cliente.estado_ahorro_activo == 1 ? 
                    '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Activo</span>' : 
                    '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Inactivo</span>'
                }
            </td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${cliente.n_productos_vigentes}</td>
            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.edad}</td>
            <td class="px-3 py-4 whitespace-nowrap">
                ${cliente.riesgo === 'ALTO' ? 
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">ALTO</span>' : 
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">BAJO</span>'
                }
            </td>
        `;
        
        // NUEVO: Event listener para click en la fila
        row.addEventListener('click', function(e) {
            // Solo si no se hizo click en el checkbox directamente
            if (e.target.type !== 'checkbox') {
                const checkbox = row.querySelector('.cliente-checkbox');
                checkbox.checked = !checkbox.checked;
                manejarSeleccionCliente();
            }
        });
        
        tbody.appendChild(row);
    });
    
    // Añadir event listeners a los checkboxes
    document.querySelectorAll('.cliente-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', manejarSeleccionCliente);
    });
}

function toggleSelectAll() {
    const selectAllChecked = document.getElementById('selectAllCheckbox').checked || 
                           document.getElementById('headerCheckbox').checked;
    
    // NUEVO: Obtener solo checkboxes visibles
    const checkboxesVisibles = document.querySelectorAll('.cliente-checkbox:not([style*="display: none"])');
    
    checkboxesVisibles.forEach(checkbox => {
        checkbox.checked = selectAllChecked;
    });
    
    // Sincronizar ambos checkboxes
    document.getElementById('selectAllCheckbox').checked = selectAllChecked;
    document.getElementById('headerCheckbox').checked = selectAllChecked;
    
    actualizarSeleccion();
}

function manejarSeleccionCliente() {
    actualizarSeleccion();
}

function actualizarSeleccion() {
    const checkboxesVisibles = document.querySelectorAll('.cliente-checkbox:not([style*="display: none"])');
    const seleccionados = document.querySelectorAll('.cliente-checkbox:checked');
    const seleccionadosVisibles = document.querySelectorAll('.cliente-checkbox:checked:not([style*="display: none"])');
    
    // Actualizar contador
    document.getElementById('selectedCount').textContent = `${seleccionados.length} clientes seleccionados`;
    
    // Habilitar/deshabilitar botón
    document.getElementById('procesarLoteBtn').disabled = seleccionados.length === 0;
    
    // CORREGIDO: Actualizar estado del select all solo basado en elementos visibles
    const todosVisiblesSeleccionados = checkboxesVisibles.length > 0 && 
                                      seleccionadosVisibles.length === checkboxesVisibles.length;
    
    document.getElementById('selectAllCheckbox').checked = todosVisiblesSeleccionados;
    document.getElementById('headerCheckbox').checked = todosVisiblesSeleccionados;
}

function aplicarFiltros() {
    const filtroRiesgo = document.getElementById('filterRiesgo').value;
    const filtroBusqueda = document.getElementById('filterSearch').value.toLowerCase();
    
    const filas = document.querySelectorAll('#personalizarTableBody tr');
    
    filas.forEach(fila => {
        const index = parseInt(fila.dataset.clienteIndex);
        const cliente = todosLosClientes[index];
        
        let mostrar = true;
        
        // Filtro por riesgo
        if (filtroRiesgo && cliente.riesgo !== filtroRiesgo) {
            mostrar = false;
        }
        
        // Filtro por búsqueda
        if (filtroBusqueda && !cliente.id.toString().toLowerCase().includes(filtroBusqueda)) {
            mostrar = false;
        }
        
        if (mostrar) {
            fila.style.display = '';
            fila.querySelector('.cliente-checkbox').style.display = '';
        } else {
            fila.style.display = 'none';
            fila.querySelector('.cliente-checkbox').style.display = 'none';
        }
    });
    
    actualizarSeleccion();
}

function limpiarSeleccion() {
    clientesSeleccionados = [];
    document.querySelectorAll('.cliente-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    document.getElementById('headerCheckbox').checked = false;
    document.getElementById('filterRiesgo').value = '';
    document.getElementById('filterSearch').value = '';
    document.getElementById('selectedCount').textContent = '0 clientes seleccionados';
    document.getElementById('procesarLoteBtn').disabled = true;
}

function procesarLoteSeleccionado() {
    const seleccionados = document.querySelectorAll('.cliente-checkbox:checked');
    
    if (seleccionados.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin selección',
            text: 'Debe seleccionar al menos un cliente para procesar.',
            confirmButtonColor: '#EF4444'
        });
        return;
    }
    
    // CORREGIDO: Obtener datos completos de clientes seleccionados
    const clientesParaProcesar = [];
    seleccionados.forEach(checkbox => {
        const index = parseInt(checkbox.dataset.index);
        const cliente = todosLosClientes[index];
        
        // MANTENER TODOS LOS DATOS ORIGINALES
        clientesParaProcesar.push({
            id: cliente.id,
            edad: cliente.edad,
            tasa_interes: cliente.tasa_interes,
            porcentaje_pago: cliente.porcentaje_pago || 100,
            dias_de_mora: cliente.dias_de_mora || 0,
            plazo_credito_meses: cliente.plazo_credito_meses || 12,
            num_microseguros: cliente.num_microseguros || 0,
            n_productos_vigentes: cliente.n_productos_vigentes,
            n_creditos_vigentes: cliente.n_creditos_vigentes || 1,
            calidad_servicio: cliente.calidad_servicio,
            estado_ahorro_activo: cliente.estado_ahorro_activo,
            // PRESERVAR DATOS ADICIONALES SI EXISTEN
            probabilidad: cliente.probabilidad,
            prediccion: cliente.prediccion,
            riesgo: cliente.riesgo,
            z_score: cliente.z_score,
            sigmoide: cliente.sigmoide
        });
    });
    
    // Resto de la función permanece igual...
    // Mostrar loading
    Swal.fire({
        title: 'Procesando lote personalizado...',
        html: `Se están procesando ${clientesParaProcesar.length} clientes seleccionados`,
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Enviar al servidor
    fetch('/api/procesar-lote', {
        method: 'POST',
        credentials: 'include',  
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            csv_data: clientesParaProcesar
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '¡Lote procesado exitosamente!',
                text: data.message,
                confirmButtonText: 'Ver resultados',
                confirmButtonColor: '#10B981'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = data.redirect_url;
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error al procesar',
                text: data.error || 'Hubo un problema al procesar el lote',
                confirmButtonColor: '#EF4444'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de conexión',
            text: 'No se pudo conectar con el servidor',
            confirmButtonColor: '#EF4444'
        });
    });
    
    // Cerrar modal
    cerrarModalPersonalizar();
}

// Variables para el ordenamiento del modal
let modalSortDirection = {};

function sortModalTable(columnIndex) {
    const tbody = document.getElementById('personalizarTableBody');
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determinar dirección de ordenamiento
    if (!modalSortDirection[columnIndex]) {
        modalSortDirection[columnIndex] = 'asc';
    } else {
        modalSortDirection[columnIndex] = modalSortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
    }
    
    // Ordenar filas
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Convertir a número si es posible según la columna
        if (columnIndex === 1 || columnIndex === 2 || columnIndex === 5 || columnIndex === 6) { // ID, Calidad Servicio, Productos, Edad
            aValue = parseInt(aValue);
            bValue = parseInt(bValue);
        } else if (columnIndex === 3) { // Tasa Interés
            aValue = parseFloat(aValue.replace('%', ''));
            bValue = parseFloat(bValue.replace('%', ''));
        } else if (columnIndex === 4) { // Estado Ahorro - ordenar por texto
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        } else if (columnIndex === 7) { // Riesgo - ordenar por texto
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        if (modalSortDirection[columnIndex] === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Reordenar filas en el DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar indicadores visuales de ordenamiento
    const table = tbody.closest('table');
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const span = headers[i].querySelector('span');
        if (span) {
            if (i === columnIndex) {
                span.textContent = modalSortDirection[columnIndex] === 'asc' ? '↑' : '↓';
            } else {
                span.textContent = '⇅';
            }
        }
    }
    
    // Actualizar selección después del ordenamiento
    actualizarSeleccion();
}
</script>
{% include 'main/modal_personalizar.html' %}
{% endblock %}