{% extends "base.html" %}

{% block content %}
<div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-sm border-r border-gray-200 min-h-screen">
        <!-- Navegación -->
        <nav class="p-4 space-y-2">
            <!-- Visualizar Datos -->
            <a href="{{ url_for('main.visualizar_datos') }}" class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-900">Visualizar Datos de Entrenamiento</div>
                        <div class="text-sm text-gray-500">Gráficos y análisis de datos</div>
                    </div>
                </div>
            </a>

            <!-- Predicción Individual -->
            <a href="{{ url_for('main.prediccion_individual') }}" class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-900">Predicción Individual</div>
                        <div class="text-sm text-gray-500">Predecir deserción de un cliente</div>
                    </div>
                </div>
            </a>

            <!-- Predicción Masiva -->
            <a href="{{ url_for('main.analisis_masivo') }}" class="block p-3 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-900">Predicción Masiva</div>
                        <div class="text-sm text-gray-500">Procesar múltiples clientes</div>
                    </div>
                </div>
            </a>
        </nav>
    </div>

    <!-- Contenido Principal -->
    <div class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Breadcrumb -->
            <div class="mb-8">
                <nav class="flex items-center space-x-2 text-sm text-gray-500">
                    <a href="{{ url_for('main.index') }}" class="hover:text-gray-700">Inicio</a>
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <a href="{{ url_for('main.analisis_masivo') }}" class="hover:text-gray-700">Análisis Masivo</a>
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-gray-900">Resultados</span>
                </nav>
            </div>

            <!-- Título de la Sección -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Resultados del Análisis Masivo</h1>
                <p class="text-gray-600">Predicciones y análisis detallado de {{ resultados.estadisticas.total_clientes }} clientes</p>
            </div>

            <!-- Estadísticas Principales -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-gray-900">{{ resultados.estadisticas.total_clientes }}</div>
                    <div class="text-sm text-gray-600">Total Clientes</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-green-600">{{ resultados.estadisticas.clientes_fieles }}</div>
                    <div class="text-sm text-gray-600">Clientes Fieles</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-red-600">{{ resultados.estadisticas.posibles_desertores }}</div>
                    <div class="text-sm text-gray-600">Posibles Desertores</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-3xl font-bold text-orange-600">{{ resultados.estadisticas.riesgo_alto }}</div>
                    <div class="text-sm text-gray-600">Riesgo Alto</div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Gráfico de Torta -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Distribución por Riesgo</h2>
                    <canvas id="pieChart" width="400" height="400"></canvas>
                </div>

                <!-- Gráfico Sigmoide -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Edad vs Probabilidad de Deserción</h2>
                    <canvas id="sigmoidChart" width="400" height="400"></canvas>
                </div>
            </div>

            <!-- Tabla de Resultados Detallados -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Resultados Detallados</h2>
                        <p class="text-gray-600">Tabla interactiva con todas las predicciones</p>
                    </div>
                    <div class="flex space-x-4">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Buscar por nombre o ID..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <button id="exportBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Exportar CSV</span>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                    ID <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                    Nombre <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                    Edad <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                    Probabilidad <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(4)">
                                    Riesgo <span class="ml-1">⇅</span>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            {% for cliente in resultados.datos_detallados %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ cliente.id }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ cliente.nombre }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ cliente.edad }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div class="flex items-center">
                                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-3">
                                            <div class="bg-blue-600 h-2 rounded-full" 
                                                style="width: {{ (cliente.probabilidad * 100) | round(1) }}%"></div>
                                        </div>
                                        <span>{{ (cliente.probabilidad * 100)|round(1) }}%</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if cliente.riesgo == 'ALTO' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            ALTO
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            BAJO
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {% if cliente.riesgo == 'ALTO' %}
                                        <span class="text-red-600">⚠️</span>
                                    {% else %}
                                        <span class="text-green-600">✅</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación info -->
                <div class="mt-4 text-sm text-gray-500">
                    Mostrando <span id="showingInfo">{{ resultados.datos_detallados|length }}</span> de {{ resultados.estadisticas.total_clientes }} resultados
                </div>
            </div>

            <!-- Botón para nuevo análisis -->
            <div class="mt-8 text-center">
                <a href="{{ url_for('main.analisis_masivo') }}" class="bg-gray-900 text-white px-8 py-3 rounded-lg hover:bg-gray-800 transition-colors inline-flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>Realizar Nuevo Análisis</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Datos desde el servidor
const datosResultados = JSON.parse('{{ resultados | tojson | safe }}');

// Gráfico de Torta
const pieCtx = document.getElementById('pieChart').getContext('2d');
const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: ['Clientes Fieles', 'Posibles Desertores'],
        datasets: [{
            data: [
                datosResultados.datos_torta.fieles.cantidad,
                datosResultados.datos_torta.desertores.cantidad
            ],
            backgroundColor: ['#10B981', '#EF4444'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const percentage = datosResultados.datos_torta[context.label.toLowerCase().replace(' ', '_').replace('posibles_', '')].porcentaje;
                        return context.label + ': ' + context.parsed + ' (' + percentage.toFixed(1) + '%)';
                    }
                }
            }
        }
    }
});

// Gráfico Sigmoide
const sigmoidCtx = document.getElementById('sigmoidChart').getContext('2d');
const sigmoidChart = new Chart(sigmoidCtx, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Predicciones',
            data: datosResultados.datos_sigmoide.map(item => ({
                x: item.z_score,
                y: item.sigmoide
            })),
            backgroundColor: datosResultados.datos_sigmoide.map(item => 
                item.prediccion === 1 ? '#EF4444' : '#10B981'
            ),
            borderColor: datosResultados.datos_sigmoide.map(item => 
                item.prediccion === 1 ? '#DC2626' : '#059669'
            ),
            borderWidth: 1,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Z-Score'
                },
                grid: {
                    display: true,
                    color: '#E5E7EB'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Probabilidad (Sigmoide)'
                },
                min: 0,
                max: 1,
                grid: {
                    display: true,
                    color: '#E5E7EB'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const prediccion = datosResultados.datos_sigmoide[context.dataIndex].prediccion;
                        const estado = prediccion === 1 ? 'Desertor' : 'Fiel';
                        return `Z-Score: ${context.parsed.x.toFixed(3)}, Probabilidad: ${(context.parsed.y * 100).toFixed(1)}%, Estado: ${estado}`;
                    }
                }
            }
        }
    }
});

// Funcionalidad de búsqueda en tabla
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tbody = document.getElementById('tableBody');
    const rows = tbody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const id = row.cells[0].textContent.toLowerCase();
        const nombre = row.cells[1].textContent.toLowerCase();
        
        if (id.includes(searchTerm) || nombre.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Actualizar contador de resultados
    document.getElementById('showingInfo').textContent = visibleCount;
});

// Funcionalidad de ordenamiento de tabla
let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.getElementById('resultsTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determinar dirección de ordenamiento
    if (!sortDirection[columnIndex]) {
        sortDirection[columnIndex] = 'asc';
    } else {
        sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
    }
    
    // Ordenar filas
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Convertir a número si es posible
        if (columnIndex === 0 || columnIndex === 2) { // ID o Edad
            aValue = parseInt(aValue);
            bValue = parseInt(bValue);
        } else if (columnIndex === 3) { // Probabilidad
            aValue = parseFloat(aValue.replace('%', ''));
            bValue = parseFloat(bValue.replace('%', ''));
        }
        
        if (sortDirection[columnIndex] === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Reordenar filas en el DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar indicadores visuales de ordenamiento
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const span = headers[i].querySelector('span');
        if (span) {
            if (i === columnIndex) {
                span.textContent = sortDirection[columnIndex] === 'asc' ? '↑' : '↓';
            } else {
                span.textContent = '⇅';
            }
        }
    }
}

// Funcionalidad de exportar CSV (placeholder)
document.getElementById('exportBtn').addEventListener('click', function() {
    // Por ahora solo muestra un mensaje
    alert('Funcionalidad de exportación será implementada próximamente');
    
    // Código para exportar CSV (comentado para futura implementación)
    /*
    const table = document.getElementById('resultsTable');
    const rows = table.querySelectorAll('tr');
    let csvContent = '';
    
    rows.forEach(row => {
        const cols = row.querySelectorAll('td, th');
        const rowData = Array.from(cols).map(col => {
            return '"' + col.textContent.trim().replace(/"/g, '""') + '"';
        });
        csvContent += rowData.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'resultados_prediccion.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    */
});

// Inicialización adicional cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar que los datos estén disponibles
    if (!datosResultados) {
        console.error('No se encontraron datos de resultados');
        return;
    }
    
    // Mostrar información en consola para debug
    console.log('Total de clientes procesados:', datosResultados.estadisticas.total_clientes);
    console.log('Clientes fieles:', datosResultados.estadisticas.clientes_fieles);
    console.log('Posibles desertores:', datosResultados.estadisticas.posibles_desertores);
    
    // Actualizar contador inicial
    const totalVisible = document.querySelectorAll('#tableBody tr').length;
    document.getElementById('showingInfo').textContent = totalVisible;
});
</script>
{% endblock %}